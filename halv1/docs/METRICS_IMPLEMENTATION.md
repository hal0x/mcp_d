# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –º–µ—Ç—Ä–∏–∫ –¥–ª—è HAL AI-–∞–≥–µ–Ω—Ç–∞

## –û–±–∑–æ—Ä

–£—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–ª—è HAL AI-–∞–≥–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ Prometheus. –°–∏—Å—Ç–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è:

- **P0 (must-have)**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- **P1 (should-have)**: ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
- **P2 (nice-to-have)**: ‚è≥ –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –ü–∞–∫–µ—Ç –º–µ—Ç—Ä–∏–∫ (`metrics/`)

- **`metrics/registry.py`** - –†–µ–µ—Å—Ç—Ä –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫ Prometheus
- **`metrics/noop.py`** - –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- **`metrics/__init__.py`** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–µ–∂–¥—É —Ä–µ–∞–ª—å–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏ –∑–∞–≥–ª—É—à–∫–∞–º–∏

**–ú–µ—Ç—Ä–∏–∫–∏:**
- `llm_latency_seconds` - –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ LLM –ø–æ –º–æ–¥–µ–ª–∏ –∏ —Ñ–∞–∑–µ
- `llm_tokens_inflight` - –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –≤ –ø–æ–ª—ë—Ç–µ
- `ab_assignment_total` - –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤ A/B —Ç–µ—Å—Ç–∞—Ö
- `coordinator_decision_total` - –†–µ—à–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞ –º–æ–¥—É–ª–µ–π
- `errors_total` - –û—à–∏–±–∫–∏ –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º –∏ —Ç–∏–ø–∞–º

### 2. –î–∞—à–±–æ—Ä–¥ (`web/dashboard/`)

- **`web/dashboard/server.py`** - FastAPI —Å–µ—Ä–≤–µ—Ä —Å —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏:
  - `GET /health` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  - `GET /metrics` - –≠–∫—Å–ø–æ—Ä—Ç –º–µ—Ç—Ä–∏–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Prometheus

### 3. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

#### LLM –∫–ª–∏–µ–Ω—Ç—ã
- **`llm/lmstudio_client.py`** - –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ latency, tokens, errors
- **`llm/ollama_client.py`** - –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ latency, tokens, errors

#### –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –º–æ–¥—É–ª–µ–π
- **`agent/coordinator.py`** - –ú–µ—Ç—Ä–∏–∫–∏ —Ä–µ—à–µ–Ω–∏–π –∏ –æ—à–∏–±–æ–∫ –º–æ–¥—É–ª–µ–π

#### –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–º—Ç–æ–≤
- **`llm/prompt_manager.py`** - A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å sticky assignment

#### –ú–æ–¥—É–ª–∏ –∞–Ω–∞–ª–∏–∑–∞
- **`agent/modules/base.py`** - –ú–µ—Ç—Ä–∏–∫–∏ –æ—à–∏–±–æ–∫ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π

#### HTTP –∫–ª–∏–µ–Ω—Ç
- **`internet/search_client.py`** - –ú–µ—Ç—Ä–∏–∫–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ HTTP –æ—à–∏–±–æ–∫

### 4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

- **`config/settings.yaml`** - –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞ –∏ –º–µ—Ç—Ä–∏–∫
- **`requirements.txt`** - –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: prometheus_client, fastapi, uvicorn
- **`main.py`** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å

### 5. –¢–µ—Å—Ç—ã

- **`tests/integration/test_metrics_endpoint.py`** - –¢–µ—Å—Ç—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –¥–∞—à–±–æ—Ä–¥–∞
- **`tests/unit/test_llm_metrics.py`** - –¢–µ—Å—Ç—ã –º–µ—Ç—Ä–∏–∫ LLM
- **`tests/unit/test_ab_assign.py`** - –¢–µ—Å—Ç—ã A/B –º–µ—Ç—Ä–∏–∫

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ –¥–∞—à–±–æ—Ä–¥–∞

```bash
# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install prometheus_client fastapi uvicorn

# –ó–∞–ø—É—Å–∫ –¥–∞—à–±–æ—Ä–¥–∞
uvicorn web.dashboard.server:app --host 0.0.0.0 --port 8080
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
curl http://localhost:8080/health

# –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Ç—Ä–∏–∫
curl http://localhost:8080/metrics
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

–î–∞—à–±–æ—Ä–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤–∫–ª—é—á–µ–Ω:

```yaml
dashboard:
  enabled: true
  host: "0.0.0.0"
  port: 8080
```

## –¢–∞–∫—Å–æ–Ω–æ–º–∏—è –º–µ—Ç—Ä–∏–∫

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (`component`)
- `llm` - LLM –∫–ª–∏–µ–Ω—Ç—ã
- `http` - HTTP –∑–∞–ø—Ä–æ—Å—ã
- `coordinator` - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –º–æ–¥—É–ª–µ–π
- `module:<name>` - –ú–æ–¥—É–ª–∏ –∞–Ω–∞–ª–∏–∑–∞
- `prompt` - –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–º—Ç–æ–≤

### –¢–∏–ø—ã –æ—à–∏–±–æ–∫ (`etype`)
- `Timeout` - –¢–∞–π–º–∞—É—Ç—ã
- `HTTP` - HTTP –æ—à–∏–±–∫–∏
- `Parse` - –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
- `Tool` - –û—à–∏–±–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- `Unknown` - –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (P1-P2)

### P1 (should-have)
- [ ] PII-—Ä–µ–¥–∞–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ JSON-–ª–æ–≥–∏
- [ ] –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
- [ ] –ü—Ä–æ–∫—Å–∏-–º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ A/B —Ç–µ—Å—Ç–æ–≤

### P2 (nice-to-have)
- [ ] –ê–ª–µ—Ä—Ç—ã Prometheus
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Grafana
- [ ] OpenTelemetry –º–æ—Å—Ç
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∞–ª–µ—Ä—Ç—ã

```yaml
# prometheus/alerts.yml
groups:
- name: hal_agent
  rules:
  - alert: LLMHighErrorRate
    expr: rate(errors_total{component="llm"}[5m]) > 0.5
    for: 10m
    labels: {severity: warning}
    annotations:
      description: "–í—ã—Å–æ–∫–∞—è –æ—à–∏–±–∫–∞ LLM –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç"
      
  - alert: DashboardDown
    expr: up{job="hal_dashboard"} == 0
    for: 2m
    labels: {severity: critical}
    annotations:
      description: "–î–∞—à–±–æ—Ä–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
```

### Grafana –¥–∞—à–±–æ—Ä–¥—ã

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥—ã –¥–ª—è:
- LLM –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (latency, throughput)
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–æ–Ω–≤–µ—Ä—Å–∏—è, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
- –û—à–∏–±–æ–∫ –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫ —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –í—Å–µ P0 —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –±–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –°–∏—Å—Ç–µ–º–∞ –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [OPTIMIZATION_AND_MEMORY_STRATEGY.md](OPTIMIZATION_AND_MEMORY_STRATEGY.md) ‚Äî –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ –ø–∞–º—è—Ç–∏
- [ARCHITECTURE.md](ARCHITECTURE.md) ‚Äî –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã
- [TESTING.md](TESTING.md) ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
