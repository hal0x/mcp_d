# HALv1 - Архитектура и Руководство

## Обзор проекта

**HALv1** — это комплексная система ИИ-агента для Telegram, объединяющая обработку сообщений, планирование задач, выполнение кода и управление памятью в единую экосистему.

## Архитектура

### Структура проекта
```
halv1/
├── agent/                 # Ядро агента
│   ├── core.py           # Основная логика агента
│   ├── coordinator.py     # Координатор модулей
│   ├── adaptation.py      # Адаптация поведения
│   └── modules/          # Модули агента
├── core/                 # Основные компоненты
│   ├── agent.py          # Базовый агент
│   ├── step_runner.py    # Исполнитель шагов
│   └── goal_validator.py # Валидатор целей
├── executor/             # Исполнители кода
│   ├── docker_executor.py # Docker исполнитель
│   ├── mcp_executor.py   # MCP исполнитель
│   └── code_generator.py # Генератор кода
├── services/             # Сервисы
│   ├── event_bus.py      # Шина событий
│   ├── monitoring.py     # Мониторинг
│   └── telethon_service.py # Telethon сервис
├── llm/                  # LLM клиенты
│   ├── base_client.py    # Базовый клиент
│   ├── ollama_client.py  # Ollama клиент
│   └── lmstudio_client.py # LM Studio клиент
├── memory/               # Система памяти
│   ├── memory_service.py # Сервис памяти
│   ├── episodic_buffer.py # Эпизодический буфер
│   └── unified_memory.py # Унифицированная память
├── bot/                  # Telegram бот
│   ├── telegram_bot.py   # Основной бот
│   ├── telethon_handlers.py # Обработчики Telethon
│   └── theme_callbacks.py # Тематические колбэки
├── config/               # Конфигурация
│   ├── settings.yaml     # Основные настройки
│   ├── prompts.yaml      # Промпты
│   └── policies.yaml     # Политики
├── docs/                 # Документация
│   ├── INDEX.md          # Главный указатель
│   ├── ARCHITECTURE.md   # Архитектура системы
│   ├── TESTING.md        # Тестирование
│   └── IMPROVEMENT_PLAN.md # План улучшений
└── tests/                # Тесты
    ├── test_planner/     # Тесты планировщика
    ├── test_core/        # Тесты ядра
    └── test_executor/    # Тесты исполнителей
```

### Компоненты системы

#### 1. Agent Core (`agent/core.py`)
- **Назначение**: Основная логика ИИ-агента
- **Функции**: 
  - Планирование задач
  - Выполнение шагов
  - Адаптация поведения
- **Паттерны**: State Machine, Event-Driven Architecture

#### 2. Executor (`executor/`)
- **Назначение**: Выполнение кода и команд
- **Функции**:
  - Docker исполнитель для изоляции
  - MCP исполнитель для интеграции
  - Генератор кода на основе LLM
- **Паттерны**: Strategy Pattern, Factory Pattern

#### 3. Services (`services/`)
- **Назначение**: Системные сервисы
- **Функции**:
  - Event Bus для коммуникации
  - Мониторинг системы
  - Telethon интеграция
- **Паттерны**: Service Layer, Observer Pattern

#### 4. Memory System (`memory/`)
- **Назначение**: Управление памятью агента
- **Функции**:
  - Эпизодическая память
  - Семантическая память
  - Унифицированное хранилище
- **Паттерны**: Memory Architecture, Graph Database

#### 5. LLM Integration (`llm/`)
- **Назначение**: Интеграция с языковыми моделями
- **Функции**:
  - Поддержка Ollama и LM Studio
  - Контекстно-зависимые клиенты
  - Управление промптами
- **Паттерны**: Adapter Pattern, Factory Pattern

## Принципы разработки

### 1. Модульность
- **Независимые компоненты**: Каждый модуль может работать автономно
- **Слабая связанность**: Минимальные зависимости между модулями
- **Высокая сплоченность**: Связанная функциональность в одном модуле
- **Интерфейсы**: Четкие интерфейсы между компонентами

### 2. Событийная архитектура
- **Event Bus**: Централизованная система событий
- **Асинхронность**: Неблокирующие операции
- **Реактивность**: Реакция на изменения состояния
- **Масштабируемость**: Легкое добавление новых обработчиков

### 3. Адаптивность
- **Обучение**: Агент учится на опыте
- **Адаптация**: Изменение поведения в зависимости от контекста
- **Персонализация**: Адаптация под пользователя
- **Эволюция**: Постоянное улучшение алгоритмов

### 4. Надежность
- **Обработка ошибок**: Graceful handling всех ошибок
- **Восстановление**: Автоматическое восстановление после сбоев
- **Мониторинг**: Постоянный мониторинг состояния
- **Логирование**: Детальное логирование всех операций

## Команды разработки

### Установка и настройка:
```bash
# Создание виртуального окружения
python -m venv venv && source venv/bin/activate

# Установка зависимостей
pip install -r requirements.txt

# Установка dev зависимостей
pip install -r requirements_search.txt
```

### Тестирование:
```bash
# Unit тесты
python -m pytest tests/ -q

# Групповые тесты
python tests/run_tests.py <group> [--verbose]

# Интеграционные тесты
python tests/run_integration_tests.py --mode fast|full [--skip-llm-check]

# Все тесты
python run_all_tests.py
```

### Качество кода:
```bash
# Линтинг
ruff check .

# Форматирование
black .

# Проверка типов
mypy .
```

## Стиль кода и именование

### Стандарты:
- **Python 3.11**: Современный синтаксис и возможности
- **Отступы**: 4 пробела для отступов
- **Docstrings**: Обязательны для публичных API
- **Форматирование**: Black (длина строки 88)
- **Линтинг**: Ruff (`E`, `F`, `I`)
- **Типизация**: mypy в строгом режиме

### Именование:
- **Модули/функции**: `snake_case`
- **Классы**: `PascalCase`
- **Константы**: `CONSTANT_CASE`
- **Приватные**: `_private_method`

## Тестирование

### Принципы:
- **TDD**: Сначала тест, потом код
- **Покрытие**: Минимум 80% покрытия кода
- **Изоляция**: Независимые тесты
- **Воспроизводимость**: Детерминированные результаты

### Структура тестов:
- **Unit тесты**: `tests/test_planner/`, `tests/test_core/`, `tests/test_executor/`
- **Интеграционные тесты**: `tests/integration/`
- **Групповые тесты**: `python tests/run_tests.py <group>`

## Конфигурация

### Основные файлы:
- **`config/settings.yaml`**: Основные настройки
- **`config/prompts.yaml`**: Промпты для LLM
- **`config/policies.yaml`**: Политики поведения
- **`.env`**: Переменные окружения

### Переменные окружения:
```bash
# Telegram
TELEGRAM_BOT_TOKEN=your_bot_token
TELETHON_API_ID=your_api_id
TELETHON_API_HASH=your_api_hash

# LLM
LLM_API_KEY=your_llm_key
EMBEDDINGS_API_KEY=your_embeddings_key

# Логирование
LOGLEVEL=INFO
```

## Развертывание

### Требования:
- Python 3.11+
- Docker (для исполнителей)
- Достаточно ресурсов для LLM

### Запуск:
```bash
# Основной режим
python main.py

# Быстрый старт
python quick_start.py

# Тестирование бота
python test_bot_quick.py
```

### Docker Compose развертывание

#### Пересборка и перезапуск после изменений кода

**⚠️ ВАЖНО**: После внесения изменений в код необходимо пересобрать контейнер и перезапустить сервис:

```bash
# Пересборка контейнера с изменениями кода
docker-compose -f ../infra/docker-compose.mcp.yml build halv1

# Перезапуск сервиса с новым образом
docker-compose -f ../infra/docker-compose.mcp.yml up -d halv1

# Проверка статуса сервиса
docker-compose -f ../infra/docker-compose.mcp.yml ps halv1

# Просмотр логов для диагностики
docker-compose -f ../infra/docker-compose.mcp.yml logs -f halv1
```

#### Полная пересборка всех сервисов

```bash
# Пересборка всех MCP сервисов
docker-compose -f ../infra/docker-compose.mcp.yml build

# Перезапуск всех сервисов
docker-compose -f ../infra/docker-compose.mcp.yml up -d

# Проверка статуса всех сервисов
docker-compose -f ../infra/docker-compose.mcp.yml ps
```

#### Отладка и диагностика

```bash
# Вход в контейнер для отладки
docker-compose -f ../infra/docker-compose.mcp.yml exec halv1 bash

# Проверка переменных окружения в контейнере
docker-compose -f ../infra/docker-compose.mcp.yml exec halv1 env

# Проверка доступности сервиса
curl http://localhost:18000/health
```

#### Очистка и пересборка с нуля

```bash
# Остановка и удаление контейнеров
docker-compose -f ../infra/docker-compose.mcp.yml down

# Удаление образов (принудительная пересборка)
docker-compose -f ../infra/docker-compose.mcp.yml build --no-cache halv1

# Запуск с чистого листа
docker-compose -f ../infra/docker-compose.mcp.yml up -d halv1
```

## Мониторинг и логирование

### Логирование:
- **Уровни**: DEBUG, INFO, WARNING, ERROR
- **Контекст**: Структурированные логи с контекстом
- **Ротация**: Автоматическая ротация логов

### Мониторинг:
- **Метрики**: Производительность, использование ресурсов
- **Алерты**: Уведомления о критических событиях
- **Дашборд**: Веб-интерфейс для мониторинга

## Безопасность

### Принципы:
1. **API ключи**: Безопасное хранение в переменных окружения
2. **Изоляция**: Выполнение кода в Docker контейнерах
3. **Валидация**: Проверка всех входных данных
4. **Мониторинг**: Отслеживание подозрительной активности

## Развитие проекта

### Приоритеты:
1. **Стабильность**: Надежная работа всех компонентов
2. **Производительность**: Оптимизация LLM запросов
3. **Функциональность**: Новые возможности агента
4. **Интеграция**: Поддержка новых сервисов

### Roadmap:
- [ ] Улучшение системы памяти
- [ ] Расширенная аналитика
- [ ] Веб-интерфейс
- [ ] Интеграция с внешними API
- [ ] Машинное обучение для адаптации

## Документация и отчёты

### ⚠️ ВАЖНО: Правила работы с документацией

**НЕ СОЗДАВАЙТЕ .md файлы отчёты каждый раз!**

- **НЕ создавайте** новые .md файлы для каждого изменения или отчёта
- **НЕ создавайте** файлы типа `REPORT_2024.md`, `CHANGES.md`, `UPDATE.md` и т.п.
- **НЕ дублируйте** информацию в разных файлах

### Ведение changelog:

**ВСЕГДА обновляйте существующие файлы:**

1. **`CHANGELOG.md`** - основной файл для записи изменений
2. **`README.md`** - обновляйте при значительных изменениях
3. **`AGENTS.md`** - обновляйте при изменениях архитектуры
4. **Существующие .md файлы** - дополняйте, не создавайте новые

### Формат changelog:
```markdown
## [Версия] - YYYY-MM-DD

### Добавлено
- Новая функциональность

### Изменено
- Изменения в существующей функциональности

### Исправлено
- Исправления ошибок

### Удалено
- Удаленная функциональность
```

### Принципы:
- **Консолидация**: Вся информация в существующих файлах
- **Обновление**: Редактируйте существующие файлы
- **Структурированность**: Используйте единый формат
- **Отслеживаемость**: Все изменения в changelog

## Качество кода и стандарты

### Code Review
- **Review guidelines**: Обязательный код-ревью для всех изменений
- **Automated checks**: Автоматические проверки через CI/CD
- **Code coverage**: Минимум 80% покрытия кода тестами
- **AI safety review**: Особое внимание к безопасности ИИ-агента

### Документация кода
- **API documentation**: Полная документация всех модулей агента
- **Code comments**: Комментарии для сложной логики ИИ
- **Type hints**: Обязательные аннотации типов для всех функций
- **Docstrings**: Строки документации для всех публичных методов

### Стандарты кодирования
- **PEP 8**: Строгое соблюдение стандартов Python
- **Black**: Автоматическое форматирование кода (длина строки 88)
- **Ruff**: Линтинг кода с правилами E, F, I
- **MyPy**: Строгая проверка типов (strict mode)

### Инструменты качества
```bash
# Форматирование кода
black .

# Линтинг
ruff check .

# Проверка типов
mypy .

# Тестирование
python run_all_tests.py
python tests/run_tests.py all --verbose

# Проверка безопасности
bandit -r .
safety check
```

### Принципы разработки
- **SOLID принципы**: Следование принципам объектно-ориентированного дизайна
- **DRY**: Не повторяйся - избегание дублирования кода
- **KISS**: Простота и понятность кода
- **AI safety first**: Безопасность ИИ превыше всего

### Структура коммитов
- **Conventional Commits**: Использование стандартного формата
- **Prefixes**: `feat:`, `fix:`, `docs:`, `test:`, `refactor:`, `perf:`, `ai:`, `memory:`
- **Scope**: Указание области изменений
- **Breaking changes**: Явное указание критических изменений

### Примеры коммитов:
```bash
feat(agent): добавить новый модуль планирования задач
fix(memory): исправить утечку памяти в эпизодическом буфере
docs(architecture): обновить документацию по системе памяти
test(executor): добавить тесты для Docker исполнителя
refactor(llm): упростить интерфейс LLM клиентов
perf(indexing): оптимизировать индексацию сообщений
ai(safety): улучшить валидацию целей агента
memory(graph): реализовать графовую память
```
