# Система анализа качества индексации Memory MCP

## Общая архитектура

Система анализа качества представляет собой отдельный модуль `analysis/quality`, который работает по принципу **реального тестирования**: извлекает информацию из исходных файлов чатов, выполняет поиск через Memory MCP, и оценивает релевантность результатов с помощью LM Studio или Ollama.

## Основные компоненты

### 1. QueryGenerator
**Функция**: Автоматическая генерация тестовых запросов из реальных сообщений

**Процесс работы**:
- Анализирует сообщения в чатах и извлекает ключевые темы, события, упоминания
- Генерирует три типа запросов:
  - **Простые фактологические**: "Когда был упомянут Bitcoin?"
  - **Контекстные**: "Что обсуждали про цену Bitcoin в январе 2024?"
  - **Аналитические**: "Какие были основные темы в этом чате?"

**Адаптивные промпты**:
- Промпты улучшаются на основе предыдущих результатов анализа
- Учитывают специфику каждого чата (крипто, NFT, технические обсуждения)
- Адаптируются к типам проблем, которые чаще всего встречаются

### 2. RelevanceAnalyzer
**Функция**: Анализ релевантности результатов через LM Studio или Ollama API

**Процесс работы**:
- Отправляет прямые HTTP запросы к LM Studio Server (приоритет) или Ollama API (fallback)
- Использует динамические батчи, подстраивающиеся под контекст модели
- Оценивает каждый результат по шкале 1-10 по трем критериям:
  - Релевантность к запросу
  - Качество извлеченной информации
  - Полнота ответа

**Graceful degradation**:
- Пустые результаты поиска → оценка 0
- Очень длинные сообщения → разбивка на части
- Некорректные запросы → анализ причин на основе данных
- Автоматический fallback на Ollama, если LM Studio недоступен

### 3. MetricsCalculator
**Функция**: Расчет сравнительных метрик качества

**Типы метрик**:
- **Относительные пороги**: сравнение с предыдущими запусками
- **Проблемы индексации**: важные сообщения не попали в индекс
- **Проблемы поиска**: релевантные результаты не находятся
- **Проблемы контекста**: результаты неполные или неточные

**A/B тестирование**:
- Сравнение результатов до и после изменений конфигурации
- Отслеживание метрик трендов во времени
- Регрессионное тестирование для проверки отсутствия ухудшений

### 4. ReportGenerator
**Функция**: Создание Markdown отчетов с выводами и рекомендациями

**Структура отчета**:
- Общие метрики качества
- Анализ по типам запросов
- Сравнение с предыдущими запусками
- Выявленные проблемы с конкретными примерами
- Автоматические рекомендации по улучшению

### 5. HistoryManager
**Функция**: Управление историей анализов в иерархической структуре

**Структура хранения**:
```
artifacts/reports/quality_analysis/
├── 2024-01-15/
│   ├── crypto_chats/
│   │   ├── analysis_results.json
│   │   └── detailed_report.md
│   └── nft_chats/
│       ├── analysis_results.json
│       └── detailed_report.md
└── 2024-01-16/
    └── ...
```

## Процесс работы

### Этап 1: Подготовка
1. **Выборочное тестирование**: пользователь выбирает конкретные чаты для анализа
2. **Генерация запросов**: QueryGenerator создает тестовые запросы из реальных сообщений
3. **Формирование батчей**: динамическое определение размера батча под контекст модели

### Этап 2: Тестирование
1. **Последовательное выполнение**: один тип сессии в одном батче
2. **Поиск через Memory MCP**: выполнение каждого запроса через существующую систему поиска (гибридный поиск, Smart Search)
3. **Анализ релевантности**: оценка результатов через LM Studio или Ollama с адаптивными промптами

### Этап 3: Анализ
1. **Статистический анализ**: выявление паттернов в проблемных случаях
2. **Расчет метрик**: сравнительные метрики с предыдущими запусками
3. **A/B сравнение**: оценка изменений после модификаций системы

### Этап 4: Отчетность
1. **Автоматические рекомендации**: LM Studio/Ollama предлагает конкретные улучшения
2. **Генерация отчета**: создание детального Markdown отчета
3. **Сохранение истории**: иерархическое хранение результатов для будущих сравнений

## Интеграция с существующей системой

### CLI команда
```bash
memory_mcp analyze-quality --chats "crypto_chat,nft_chat" --config quality_config.json
```

### Конфигурация
```json
{
  "quality_analysis": {
    "lmstudio_host": "127.0.0.1",
    "lmstudio_port": 1234,
    "lmstudio_llm_model": "gpt-oss-20b",
    "ollama_base_url": "http://localhost:11434",
    "ollama_model": "gpt-oss-20b:latest",
    "batch_size": "dynamic",
    "query_types": ["factual", "contextual", "analytical"],
    "relevance_threshold": 7.0,
    "history_retention_days": 30
  }
}
```

**Приоритет LLM провайдера:**
1. LM Studio (если `lmstudio_llm_model` указан)
2. Ollama (fallback, если LM Studio недоступен или не настроен)

## Преимущества системы

1. **Реальное тестирование**: использует реальные данные и запросы
2. **Автоматизация**: минимальное участие пользователя в процессе
3. **Адаптивность**: система улучшается на основе собственных результатов
4. **Сравнительность**: отслеживание улучшений во времени
5. **Практичность**: конкретные рекомендации по улучшению системы

Эта система позволит постоянно мониторить и улучшать качество индексации и поиска в Memory MCP, обеспечивая высокое качество результатов для пользователей.

## Интеграция с гибридным поиском

Система анализа качества поддерживает тестирование различных типов поиска:
- **Гибридный поиск** (BM25 + Vector) - основной метод поиска
- **Smart Search** - интерактивный LLM-assisted поиск
- **Векторный поиск** - поиск только по эмбеддингам
- **Полнотекстовый поиск** - поиск только по BM25

Это позволяет оценивать эффективность каждого метода и оптимизировать параметры гибридного поиска (веса BM25 и Vector, параметры RRF).
