# Архитектура Telegram Dump Manager

Документ описывает ключевые слои системы, основные компоненты и потоки данных проекта.
Он предназначен для разработчиков, которые хотят быстрее разобраться в устройстве
индексатора и аналитического стека.

## Слойная модель

| Слой | Назначение | Ключевые директории/файлы |
|------|------------|---------------------------|
| Внешние интерфейсы | CLI, сценарии автоматизации, MCP‑сервер | `src/memory_mcp/cli/`, `scripts/`, `src/memory_mcp/mcp/server.py`, `run_server.py` |
| Оркестрация и ядро | Управление индексированием, доступ к Ollama и хранилищам | `src/memory_mcp/core/indexer.py`, `src/memory_mcp/core/ollama_client.py` |
| Аналитика и агрегация | Сегментация, саммаризация, контроль качества, кластеры, отчёты | `src/memory_mcp/analysis/` |
| Поиск и память | Векторный/гибридный поиск, граф инсайтов и долговременная память | `src/memory_mcp/search/`, `src/memory_mcp/memory/` |
| Утилиты и конфигурация | Общие вспомогательные функции и конфиги | `src/memory_mcp/utils/`, `config/`, `config.json` |

## Потоки данных

```text
входные дампы → предварительная фильтрация → сегментация сессий →
саммаризация → сохранение Markdown отчётов →
индексация сообщений/сессий в ChromaDB →
(опц.) кластеризация + граф инсайтов →
поиск, отчёты и внешние интеграции
```

1. **Загрузка данных**: JSON/JSONL файлы из `./chats/` читаются командами CLI и
   передаются в `TwoLevelIndexer`.
2. **Сегментация**: `SessionSegmenter` и `DayGroupingSegmenter` формируют сессии и
   дневные группы на основе временных интервалов.
3. **Саммаризация и контроль качества**: `SessionSummarizer` вызывает Ollama через
   `OllamaEmbeddingClient`, оценивает результат через `analysis/quality_evaluator.py` и при
   необходимости повторно уточняет сводку.
4. **Агрегация и кластеры**: `SmartRollingAggregator`, `SessionClusterer` и
   `ClusterSummarizer` группируют активность и строят тематические кластеры.
5. **Индексирование**: сообщения, сессии, задачи и кластеры пишутся в ChromaDB
   (коллекции `telegram_messages`, `chat_sessions`, `chat_tasks`, `session_clusters`).
6. **Отчёты и память**: Markdown‑отчёты сохраняются в `./summaries/`, граф инсайтов
   строится через `memory/graph_builder.py`, результаты доступны командам поиска и API.

## Основные компоненты

### CLI и внешние интерфейсы

- `src/memory_mcp/cli/main.py` — точка входа для команд `index`, `summarize`, `search`,
  `insight-graph` и комплексного пайплайна `full-process`.
- `src/memory_mcp/mcp/server.py` — MCP сервер для stdio режима (интеграции с MCP клиентами).
- `run_server.py` — HTTP сервер для Docker/продакшена (FastAPI + FastApiMCP).
- Директория `scripts/` содержит вспомогательные утилиты (например, проверку окружения).

### Ядро индексатора

- `TwoLevelIndexer` управляет всем циклом: от подготовки коллекций ChromaDB до
  сохранения результатов в файловую систему.
- `OllamaEmbeddingClient` инкапсулирует HTTP вызовы Ollama, поддерживает длинные
  контексты, тайм‑ауты и ретраи.
- Менеджер инструкций `InstructionManager` позволяет централизованно обновлять промпты
  для LLM операций.

### Аналитические сервисы

- **Сегментация**: `SessionSegmenter`, `DayGroupingSegmenter`, `SmartRollingAggregator`
  (динамический выбор стратегии NOW/FRESH/RECENT для потоковых чатов).
- **Саммаризация**: `SessionSummarizer`, `ClusterSummarizer`, `MarkdownRenderer`.
- **Качество**: `analysis/quality_evaluator.py` и `IterativeRefiner` для итеративного
  повышения оценок саммари.
- **Тематика и сущности**: `EntityExtractor`, `SessionClusterer`, `ClusterSummarizer`.
- **Инкрементальные сценарии**: `incremental_context_manager.py` поддерживает добор
  свежих сообщений без пересоздания всего индекса.
- **Контекст и фильтрация**: `context_manager.py`, `message_filter.py`,
  `instruction_manager.py`.

### Поиск и долговременная память

- `search/hybrid_search.py` комбинирует семантический и лексический поиск по коллекциям
  ChromaDB.
- `search/search_explainer.py` формирует понятный разбор найденных документов.
- Модуль `memory/` хранит граф инсайтов: `graph_builder.py` создает узлы/рёбра,
  `importance_scoring.py` ранжирует факты, `typed_graph.py` описывает схему графа.

## Хранилища и артефакты

| Артефакт | Расположение | Что содержит |
|----------|--------------|--------------|
| Исходные дампы | `./chats/` | Экспортированные сообщения Telegram |
| Векторные коллекции | `./chroma_db/` | Сообщения, сессии, задачи, кластеры |
| Markdown‑саммари | `./summaries/` | Итоговые отчёты по чатам и кластерам |
| Граф инсайтов | `artifacts/smart_aggregation_state/`, `artifacts/reports/` | JSON состояния окон и итоговые отчёты |
| Конфигурация | `config.json`, `config/` | Значения по умолчанию для CLI и аналитики |

## Внешние зависимости

- **Ollama** — источник эмбеддингов и генеративных саммаризаций (`ollama serve`).
- **ChromaDB** — персистентное векторное хранилище коллекций.
- **PyTorch / ML‑библиотеки** — задействуются Ollama и локальными LLM‑моделями.

## Расширение системы

1. Добавьте новую аналитику в `src/memory_mcp/analysis/`, экспортируйте класс в
   `__init__.py`, подключите его в `TwoLevelIndexer` или CLI.
2. Новые CLI‑команды регистрируйте в `src/memory_mcp/cli/main.py`, переиспользуя существующие
   сервисы из `core` и `analysis`.
3. Для дополнительных коллекций определите схему в индексаторе и обновите раздел
   «Хранилища» в документации.

