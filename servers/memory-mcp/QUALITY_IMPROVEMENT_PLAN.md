# План улучшения качества кода

## Цели

- Сократить дублирование описаний, чтобы новые инструменты и хранилища документировались в одном месте.
- Упростить критичные цепочки выполнения (`call_tool`, вспомогатели индексации), чтобы их было легче понимать и тестировать.
- Централизовать общие утилиты (парсинг дат, поиск корня проекта), устранив копипасту.
- Повысить наблюдаемость фоновых/асинхронных задач, чтобы быстрее диагностировать сбои.

## Приоритетные инициативы

1. **Рефакторинг реестра инструментов**
   - Создать реестр, сопоставляющий имя инструмента с обработчиком и схемой запроса.
   - Генерировать описания для `list_tools()` и список `features` в `get_version_payload()` из реестра.
   - Заменить лестницу `elif` в `call_tool()` на диспетчер, который один раз выполняет логирование и обработку ошибок.

2. **Общие нормализаторы аргументов**
   - Добавить валидаторы или хелперы для типовых преобразований (ISO-даты, массивы тегов, флаги).
   - Использовать хелпер во всех потоках export/search/timeline вместо копирования `_parse_date_safe`.
   - Написать точечные unit-тесты на невалидные входы, чтобы ловить регрессии.

3. **Утилита разрешения корня проекта**
   - Вынести повторяющуюся логику «подняться до `pyproject.toml`» в `utils.paths.resolve_project_path()`.
   - Перевести адаптеры, markdown renderer и серверный bootstrap на новый helper.
   - Добавить логирование и тесты для краевых случаев (запуск из подпапок, установленные пакеты).

4. **Наведение порядка в жизненном цикле фоновой индексации**
   - Инкапсулировать доступ к `_active_indexing_jobs` в небольшой менеджер, чтобы избежать прямых операций с dict.
   - Гарантировать атомарное обновление статуса и предоставить read-only API для диагностики.
   - Добавить хуки корректного завершения и тесты сценариев перезапуска.

5. **Документация и защитные механизмы**
   - Описать новый подход с реестром и хелперами в `AGENTS.md`.
   - Добавить lint/test-проверки (mypy-плагин, pytest), убеждающиеся, что у каждого инструмента есть документация/примеры.
   - Расширить CI тестами структуры, чтобы дубли схем не появлялись незамеченными.

## Метрики успеха

- Уменьшение размера `src/memory_mcp/mcp/server.py` минимум на 30% без потери функциональности.
- 100% соответствие между инструментами в реестре, диспетчере и документации (проверяется автотестом).
- Замеряемое снижение дублирующегося кода по отчётам `radon`/`flake8-simplify`.
- Быстрое онбординг: для добавления нового инструмента достаточно изменить ≤2 файла.
