# План улучшения качества кода

## Контекст

Memory MCP эволюционировал до набора сервисов (реестр MCP инструментов, адаптеры памяти, фоновые индексаторы, CLI).
Разрастание серверного слоя привело к дублированию описаний инструментов, частным парсерам аргументов и ручному
управлению жизненным циклом фоновых задач. План фокусируется на устранении этих источников технического долга.

## Цели

- Синхронизировать описание инструментов, схемы аргументов и документацию, чтобы единственный источник правды лежал в коде.
- Свести к минимуму ручные преобразования входных данных благодаря переиспользуемым валидаторам и helper-утилитам.
- Сделать фоновые процессы (индексация, анализ качества) наблюдаемыми и безопасно останавливаемыми.
- Обеспечить неизменяемые правила конфигурации (поиск корня проекта, переменные окружения) для всех режимов запуска.
- Встроить проверки качества (lint/tests) так, чтобы регрессии в API и документации выявлялись до релиза.

## Приоритетные инициативы

1. **Единый реестр инструментов и схем**
   - Собрать декларативный реестр (`tools_registry.py` или аналог) с `name`, `description`, Pydantic-моделью аргументов и обработчиком.
   - Подключить `list_tools()` и `get_version_payload()` к реестру, чтобы описания и список возможностей генерировались автоматически.
   - В `call_tool()` заменить каскад `if/elif` на единый диспетчер, который:
     - находит спецификацию в реестре, валидирует аргументы и запускает обработчик,
     - централизует логирование, форматирование и обработку ошибок через `quality_analyzer.utils.error_handler`.
   - Добавить автотест, сверяющий наличие документации/примеров в `AGENTS.md` для каждого инструмента из реестра.

2. **Общие нормализаторы аргументов и конфигурации**
   - Создать модуль `src/memory_mcp/utils/validators.py` с хелперами: ISO8601 даты, массивы тегов/entities, флаги, `aggregation_strategy`.
   - Интегрировать хелперы в ingest/search/export CLI, MCP сервер и анализаторы, устранив локальные `_parse_date_*`.
   - Разработать `utils.paths.resolve_project_path()` / `get_data_dir()` и заменить ручной поиск `pyproject.toml`, чтобы все сервисы одинаково определяли пути и `MEMORY_MCP_DB_PATH`.
   - Покрыть helper-логику точечными unit-тестами на краевые сценарии (пустые значения, неверные форматы, запуск из подпапок).

3. **Повышение наблюдаемости фоновой индексации**
   - Обернуть `_active_indexing_jobs` и смежные структуры в менеджер (например, `IndexingJobRegistry`), предоставляющий CRUD и снапшоты состояний.
   - Добавить структурированное логирование и метрики (prometheus events/diagnostic endpoints) для ключевых стадий: скачивание, нормализация, upsert в Qdrant/graph.
   - Реализовать хуки graceful shutdown: остановка задач при `SIGTERM`, закрытие адаптера, flush очередей.
   - Написать тесты, моделирующие перезапуск/краш, чтобы убедиться, что статусы и блокировки восстанавливаются корректно.

4. **Автоматизированные проверки API и поискового качества**
   - Добавить фикстуры `pytest` для гибридного поиска: синтетические записи → FTS+вектор → сравнение ожидаемого ранжирования.
   - Ввести smoke-тест для MCP stdio режима, который запускает `python -m memory_mcp.mcp.server`, вызывает `list_tools`, `health`, `search_memory` и проверяет ответы.
   - Подключить `radon`, `flake8-simplify` и `mypy` (строгие настройки для `memory/mcp` пакета) в CI, чтобы контролировать рост сложностей.
   - Для регресса качества поиска включить `quality_analyzer` в pipeline: фиксированные запросы, baseline метрики, уведомление при деградации.

5. **Документация и контроль качества артефактов**
   - Расширить `AGENTS.md` разделом, описывающим новый реестр инструментов, формат описаний и правила обновления документации.
   - Обновить `README.md`/`CHANGELOG.md` после каждого изменения API или схемы конфигурации, добавив checklist в PR шаблон.
   - Настроить CI шаг, проверяющий, что при изменении `tools_registry` изменяется и документация (git diff guard).
   - Подготовить примеры конфигурации (`docs/examples/*.md`) для основных режимов: HTTP + Docker Compose, stdio, встраивание в Cursor.

## Контрольные точки

- **Неделя 1**: MVP реестра инструментов, подключение к `list_tools()` и первичные тесты.
- **Неделя 2**: Внедрение helper-утилит для дат/путей и покрытие ingest/search CLI.
- **Неделя 3**: Новый менеджер фоновых задач + базовые метрики/логи.
- **Неделя 4**: Расширенные тесты гибридного поиска и smoke-сценария MCP; обновление документации.

## Метрики успеха

- `src/memory_mcp/mcp/server.py` сокращён минимум на 30% (измеряется `cloc` + `radon cc`).
- Тесты на валидаторы/инструменты выполняются < 1 мин и охватывают ≥90% критичных ветвей (`pytest --cov`).
- 100% соответствие между инструментами, указанными в реестре, `list_tools()`, `AGENTS.md` и `QUALITY_IMPROVEMENT_PLAN.md` (проверяется автотестом).
- Сценарии фоновой индексации восстанавливаются после перезапуска без потери статуса ≥99% случаев (наблюдается в интеграционном тесте).
- Onboarding: добавление нового инструмента требует правок ≤2 файлов (реестр + обработчик) и проходит CI без ручных правок документации.
