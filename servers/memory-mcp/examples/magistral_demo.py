#!/usr/bin/env python3
"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–µ–ª—å—é Magistral-Small-2509 –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
"""

import asyncio
import time
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from src.memory_mcp.core.ollama_client import OllamaEmbeddingClient


async def demo_magistral_analysis():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–µ–ª—å—é Magistral-Small-2509"""
    
    print("üöÄ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è Magistral-Small-2509")
    print("=" * 60)
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç
    async with OllamaEmbeddingClient() as client:
        
        # –¢–µ—Å—Ç 1: –ê–Ω–∞–ª–∏–∑ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        print("\nüìù –¢–µ—Å—Ç 1: –ê–Ω–∞–ª–∏–∑ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞")
        print("-" * 40)
        
        short_text = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –ø–æ–≥–æ–¥–µ. –ù—É–∂–Ω–æ —É–∑–Ω–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∑–∞–≤—Ç—Ä–∞."
        
        start_time = time.time()
        analysis = await client.generate_summary(short_text)
        end_time = time.time()
        
        print(f"‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ {end_time - start_time:.2f} —Å–µ–∫—É–Ω–¥")
        print(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: {analysis}")
        
        # –¢–µ—Å—Ç 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
        print("\nüî¢ –¢–µ—Å—Ç 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤")
        print("-" * 40)
        
        texts = [
            "–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç - —ç—Ç–æ –±—É–¥—É—â–µ–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π",
            "–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–µ—à–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏",
            "–°–µ–≥–æ–¥–Ω—è —Ö–æ—Ä–æ—à–∞—è –ø–æ–≥–æ–¥–∞ –¥–ª—è –ø—Ä–æ–≥—É–ª–∫–∏"
        ]
        
        start_time = time.time()
        embeddings = await client.generate_embeddings(texts)
        end_time = time.time()
        
        print(f"‚úÖ –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∑–∞ {end_time - start_time:.2f} —Å–µ–∫—É–Ω–¥")
        print(f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤: {len(embeddings)}")
        print(f"üìè –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å: {len(embeddings[0]) if embeddings else 0}")
        
        # –¢–µ—Å—Ç 3: –ê–Ω–∞–ª–∏–∑ –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        print("\nüìÑ –¢–µ—Å—Ç 3: –ê–Ω–∞–ª–∏–∑ –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞")
        print("-" * 40)
        
        long_text = """
        –í —á–∞—Ç–µ –æ–±—Å—É–∂–¥–∞–µ—Ç—Å—è –ø—Ä–æ–µ–∫—Ç –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. 
        –£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ–±—Å—É–∂–¥–∞—é—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã: –¥–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, 
        —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, —Å—Ä–æ–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –ï—Å—Ç—å —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏—è –ø–æ –ø–æ–≤–æ–¥—É 
        –≤—ã–±–æ—Ä–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç–µ–∫–∞. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç React Native, 
        –¥—Ä—É–≥–∏–µ - Flutter. –¢–∞–∫–∂–µ –æ–±—Å—É–∂–¥–∞–µ—Ç—Å—è –≤–æ–ø—Ä–æ—Å —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç—å—é.
        –ù—É–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞–¥–∞—á–∏ –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.
        """ * 3  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç
        
        start_time = time.time()
        analysis_long = await client.generate_summary(long_text)
        end_time = time.time()
        
        print(f"‚úÖ –ê–Ω–∞–ª–∏–∑ –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞ {end_time - start_time:.2f} —Å–µ–∫—É–Ω–¥")
        print(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: {analysis_long}")
        
        # –¢–µ—Å—Ç 4: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
        print("\n‚ö° –¢–µ—Å—Ç 4: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞")
        print("-" * 40)
        
        texts_parallel = [
            "–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–µ–∫—Ç–µ",
            "–í—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏",
            "–¢—Ä–µ—Ç—å–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏",
            "–ß–µ—Ç–≤–µ—Ä—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ—à–µ–Ω–∏—è–º–∏"
        ]
        
        start_time = time.time()
        tasks = [client.generate_summary(text) for text in texts_parallel]
        analyses_parallel = await asyncio.gather(*tasks)
        end_time = time.time()
        
        print(f"‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ {end_time - start_time:.2f} —Å–µ–∫—É–Ω–¥")
        print(f"üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ç–µ–∫—Å—Ç–æ–≤: {len(analyses_parallel)}")
        
        # –¢–µ—Å—Ç 5: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
        print("\nüîç –¢–µ—Å—Ç 5: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤")
        print("-" * 40)
        
        similar_texts = [
            "–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ",
            "AI —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤—Å–µ –ª—É—á—à–µ"
        ]
        
        different_texts = [
            "–°–µ–≥–æ–¥–Ω—è —Å–æ–ª–Ω–µ—á–Ω–∞—è –ø–æ–≥–æ–¥–∞",
            "–ó–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç –¥–æ–∂–¥—å"
        ]
        
        start_time = time.time()
        similar_embeddings = await client.generate_embeddings(similar_texts)
        different_embeddings = await client.generate_embeddings(different_texts)
        end_time = time.time()
        
        print(f"‚úÖ –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∑–∞ {end_time - start_time:.2f} —Å–µ–∫—É–Ω–¥")
        
        # –ü—Ä–æ—Å—Ç–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ (–∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ)
        if similar_embeddings and different_embeddings:
            import numpy as np
            
            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–µ–∫—Ç–æ—Ä—ã
            sim1 = np.array(similar_embeddings[0])
            sim2 = np.array(similar_embeddings[1])
            diff1 = np.array(different_embeddings[0])
            diff2 = np.array(different_embeddings[1])
            
            # –ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ
            similarity_same = np.dot(sim1, sim2) / (np.linalg.norm(sim1) * np.linalg.norm(sim2))
            similarity_diff = np.dot(diff1, diff2) / (np.linalg.norm(diff1) * np.linalg.norm(diff2))
            
            print(f"üìä –°—Ö–æ–¥—Å—Ç–≤–æ –ø–æ—Ö–æ–∂–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤: {similarity_same:.4f}")
            print(f"üìä –°—Ö–æ–¥—Å—Ç–≤–æ —Ä–∞–∑–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤: {similarity_diff:.4f}")
    
    print("\nüéâ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    print("=" * 60)


if __name__ == "__main__":
    asyncio.run(demo_magistral_analysis())
