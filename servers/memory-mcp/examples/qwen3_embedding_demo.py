#!/usr/bin/env python3
"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –º–æ–¥–µ–ª–∏ Qwen3-Embedding-4B
"""

import asyncio
import time
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from src.memory_mcp.core.ollama_client import OllamaEmbeddingClient


async def demo_qwen3_embedding():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–µ–ª—å—é Qwen3-Embedding-4B"""
    
    print("üöÄ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ Qwen3-Embedding-4B")
    print("=" * 50)
    
    async with OllamaEmbeddingClient() as client:
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        print("1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...")
        connection_result = await client.test_connection()
        
        if connection_result["model_available"]:
            print("‚úÖ –ú–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞!")
            print(f"   - –ù–∞–∑–≤–∞–Ω–∏–µ: {connection_result['model_name']}")
            print(f"   - –í–µ—Ä—Å–∏—è Ollama: {connection_result.get('ollama_version', 'unknown')}")
        else:
            print("‚ùå –ú–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞!")
            return
        
        print("\n2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞...")
        short_text = "–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
        start_time = time.time()
        short_embedding = await client.get_embedding(short_text)
        short_time = time.time() - start_time
        
        print(f"‚úÖ –†–∞–∑–º–µ—Ä —ç–º–±–µ–¥–¥–∏–Ω–≥–∞: {len(short_embedding)} –∏–∑–º–µ—Ä–µ–Ω–∏–π")
        print(f"‚è±Ô∏è  –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {short_time:.2f} —Å–µ–∫—É–Ω–¥")
        
        print("\n3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞...")
        # –°–æ–∑–¥–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (–æ–∫–æ–ª–æ 30K —Ç–æ–∫–µ–Ω–æ–≤)
        long_text = """
        –≠—Ç–æ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –º–æ–¥–µ–ª–∏ Qwen3-Embedding-4B.
        –ú–æ–¥–µ–ª—å —Å–ø–æ—Å–æ–±–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–æ 40960 —Ç–æ–∫–µ–Ω–æ–≤, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ü–µ–ª—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏,
        —Å—Ç–∞—Ç—å—è–º–∏, –≥–ª–∞–≤–∞–º–∏ –∫–Ω–∏–≥ –∏ –¥—Ä—É–≥–∏–º–∏ –æ–±—ä–µ–º–Ω—ã–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏.
        
        –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏:
        - –†–∞–∑–º–µ—Ä —ç–º–±–µ–¥–¥–∏–Ω–≥–∞: 2560 –∏–∑–º–µ—Ä–µ–Ω–∏–π (–≤ 2.5 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ —á–µ–º —É –¥—Ä—É–≥–∏—Ö –º–æ–¥–µ–ª–µ–π)
        - –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ–∫–Ω–æ: 40960 —Ç–æ–∫–µ–Ω–æ–≤ (–≤ 80 —Ä–∞–∑ –±–æ–ª—å—à–µ —á–µ–º —É mxbai-embed-large)
        - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ–ª–µ–µ 100 —è–∑—ã–∫–æ–≤
        - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–æ–Ω–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∑–∞–¥–∞—á–∞–º
        
        –ú–æ–¥–µ–ª—å –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:
        - –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –±–æ–ª—å—à–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
        - –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤
        - –ê–Ω–∞–ª–∏–∑–∞ —Å—Ö–æ–¥—Å—Ç–≤–∞ –º–µ–∂–¥—É –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
        - –†–∞–±–æ—Ç—ã —Å –º–Ω–æ–≥–æ—è–∑—ã—á–Ω—ã–º–∏ –∫–æ—Ä–ø—É—Å–∞–º–∏
        - –û–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª–∏–Ω–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –∏ —á–∞—Ç–æ–≤
        
        """ * 200  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç
        
        print(f"üìè –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {len(long_text)} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"üî¢ –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤: {len(long_text) // 3.5:.0f}")
        
        start_time = time.time()
        long_embedding = await client.get_embedding(long_text)
        long_time = time.time() - start_time
        
        print(f"‚úÖ –†–∞–∑–º–µ—Ä —ç–º–±–µ–¥–¥–∏–Ω–≥–∞: {len(long_embedding)} –∏–∑–º–µ—Ä–µ–Ω–∏–π")
        print(f"‚è±Ô∏è  –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {long_time:.2f} —Å–µ–∫—É–Ω–¥")
        
        print("\n4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏...")
        texts = [
            "–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è",
            "–í—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ",
            "–¢—Ä–µ—Ç—å–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º",
            "–ß–µ—Ç–≤–µ—Ä—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç–∏",
            "–ü—è—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞—é—â–µ–µ —Ç–µ—Å—Ç"
        ]
        
        start_time = time.time()
        embeddings = await client.generate_embeddings(texts)
        parallel_time = time.time() - start_time
        
        print(f"‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {len(embeddings)} —Ç–µ–∫—Å—Ç–æ–≤")
        print(f"‚è±Ô∏è  –û–±—â–µ–µ –≤—Ä–µ–º—è: {parallel_time:.2f} —Å–µ–∫—É–Ω–¥")
        print(f"üìä –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞ —Ç–µ–∫—Å—Ç: {parallel_time/len(texts):.2f} —Å–µ–∫—É–Ω–¥")
        
        print("\n5. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:")
        print(f"   - –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç ({len(short_text)} —Å–∏–º–≤–æ–ª–æ–≤): {short_time:.2f}—Å")
        print(f"   - –î–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç ({len(long_text)} —Å–∏–º–≤–æ–ª–æ–≤): {long_time:.2f}—Å")
        print(f"   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ ({len(texts)} —Ç–µ–∫—Å—Ç–æ–≤): {parallel_time:.2f}—Å")
        
        print("\nüéâ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
        print("–ú–æ–¥–µ–ª—å Qwen3-Embedding-4B –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏!")


if __name__ == "__main__":
    asyncio.run(demo_qwen3_embedding())
