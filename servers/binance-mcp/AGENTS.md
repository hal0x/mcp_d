# Binance Native MCP Server - Архитектура и Руководство

## Обзор проекта

**Binance Native MCP** — это MCP сервер для работы с Binance API, предоставляющий инструменты для торговли, анализа рынка и управления портфелем.

## Архитектура

### Структура проекта
```
binance-mcp/
├── src/                    # Основной код
│   ├── config.py          # Конфигурация и настройки
│   ├── models.py          # Pydantic модели данных
│   ├── services.py        # Бизнес-логика и сервисы
│   ├── client.py          # Binance API клиент
│   └── api.py             # FastAPI эндпоинты
├── mcp_server.py          # Главный MCP сервер
├── docs/                  # Документация
├── examples/              # Примеры использования
├── tests/                 # Тесты
└── pyproject.toml         # Конфигурация проекта
```

### Компоненты системы

#### 1. MCP Server (`mcp_server.py`)
- **Назначение**: Главная точка входа MCP сервера
- **Функции**: 
  - Регистрация инструментов (tools)
  - Обработка вызовов инструментов
  - Поддержка stdio и HTTP транспортов
- **Паттерны**: FastMCP, декораторы для инструментов

#### 2. Configuration (`src/config.py`)
- **Назначение**: Управление конфигурацией приложения
- **Функции**:
  - Загрузка переменных окружения
  - Валидация API ключей
  - Поддержка демо и продакшн режимов
- **Паттерны**: Dataclass, LRU cache, property методы

#### 3. Models (`src/models.py`)
- **Назначение**: Типизированные модели данных
- **Функции**:
  - Pydantic модели для API запросов/ответов
  - Валидация данных
  - Сериализация/десериализация
- **Паттерны**: Pydantic BaseModel, Optional типы

#### 4. Services (`src/services.py`)
- **Назначение**: Бизнес-логика и интеграция с Binance API
- **Функции**:
  - AccountService - управление аккаунтом
  - MarketService - рыночные данные
  - OrderService - торговые операции
  - PortfolioService - управление портфелем
  - RiskManagementService - управление рисками
- **Паттерны**: Service Layer, Dependency Injection

#### 5. Client (`src/client.py`)
- **Назначение**: Низкоуровневая интеграция с Binance API
- **Функции**:
  - HTTP клиент для Binance API
  - Обработка аутентификации
  - Управление rate limits
- **Паттерны**: HTTP Client, Authentication

## Принципы разработки

### 1. Типизация
- **Строгая типизация**: Все функции и методы типизированы
- **Pydantic модели**: Для валидации и сериализации данных
- **Optional типы**: Для опциональных параметров

### 2. Конфигурация
- **Переменные окружения**: Все настройки через ENV
- **Демо режим**: Поддержка тестовой торговли
- **Валидация**: Проверка обязательных параметров при запуске

### 3. Обработка ошибок
- **Graceful degradation**: Сервер продолжает работать при ошибках
- **Детальное логирование**: Все операции логируются
- **Пользовательские сообщения**: Понятные сообщения об ошибках

### 4. Безопасность
- **API ключи**: Безопасное хранение в переменных окружения
- **Демо режим**: Изоляция тестовой торговли
- **Валидация**: Проверка всех входных данных

## Инструменты (Tools)

### Основные категории:
1. **Account** - управление аккаунтом
2. **Market** - рыночные данные
3. **Orders** - торговые операции
4. **Portfolio** - управление портфелем
5. **Risk Management** - управление рисками
6. **Batch Operations** - массовые операции

### Паттерны инструментов:
- **Валидация входных данных**: Проверка обязательных параметров
- **Декораторы**: `@mcp.tool()` для регистрации
- **Логирование**: Детальное логирование вызовов
- **Обработка ошибок**: Try-catch с понятными сообщениями

### Стандарт описания инструментов
- **Первая фраза**: краткое действие (≤90 символов), настоящее время, начинаем с глагола.
- **Язык**: используем английский, чтобы вывод `list_tools` выглядел единообразно во всех MCP.
- **Дополнительные детали**: переносим во второе предложение docstring или документацию, не перегружаем `description`.
- **Реализация**: в `mcp_server.list_tools` описания поддерживаем в едином стиле с FastMCP-проектами.

### Документация инструментов (best practices)
- Чётко описывайте обязательные поля (`symbol`, `side`, `quantity`) и взаимоисключающие параметры (например, `price` XOR `stop_price`).
- Добавляйте примеры запросов с реальными данными Binance (спот, фьючерсы, режимы isolated/cross).
- Для коллекций (списки символов, массивы ордеров) показывайте ожидаемый формат JSON.
- Фиксируйте диапазоны и форматы числовых параметров (`quantity`, `leverage`, `pricePrecision`).
- В подсказках приводите типичные сценарии: как создать лимитный ордер, как отменить ордера батчем, как переключиться на демо режим.
- Для `get_klines` и батч-версии указывайте, что поддерживаются `start_time`/`end_time` (миллисекунды UTC) и что возвращается весь диапазон свечей, необходимый для бэктестов.

## Тестирование

### Структура тестов:
```
tests/
├── test_models.py         # Тесты моделей
├── test_services.py       # Тесты сервисов
├── test_client.py         # Тесты клиента
└── conftest.py           # Конфигурация тестов
```

### Принципы тестирования:
- **Unit тесты**: Для каждого компонента
- **Mock объекты**: Для внешних API
- **Покрытие кода**: Минимум 80%
- **Интеграционные тесты**: Для критических путей

## Развертывание

### Переменные окружения:
```bash
# Основные API ключи
BINANCE_API_KEY=your_api_key
BINANCE_API_SECRET=your_api_secret

# Демо API ключи (опционально)
DEMO_BINANCE_API_KEY=demo_api_key
DEMO_BINANCE_API_SECRET=demo_api_secret

# Режим работы
BINANCE_DEMO_TRADING=false

# Сервер
HOST=0.0.0.0
PORT=8000

# Telegram уведомления (опционально)
TELEGRAM_BOT_TOKEN=bot_token
TELEGRAM_CHAT_ID=chat_id
```

### Запуск:
```bash
# Установка зависимостей
pip install -e .

# Запуск в stdio режиме
python mcp_server.py

# Запуск в HTTP режиме
python mcp_server.py --host 0.0.0.0 --port 8000
```

### Docker Compose развертывание

#### Пересборка и перезапуск после изменений кода

**⚠️ ВАЖНО**: После внесения изменений в код необходимо пересобрать контейнер и перезапустить сервис:

```bash
# Пересборка контейнера с изменениями кода
docker-compose -f ../../infra/docker-compose.mcp.yml build binance-mcp

# Перезапуск сервиса с новым образом
docker-compose -f ../../infra/docker-compose.mcp.yml up -d binance-mcp

# Проверка статуса сервиса
docker-compose -f ../../infra/docker-compose.mcp.yml ps binance-mcp

# Просмотр логов для диагностики
docker-compose -f ../../infra/docker-compose.mcp.yml logs -f binance-mcp
```

#### Полная пересборка всех сервисов

```bash
# Пересборка всех MCP сервисов
docker-compose -f ../../infra/docker-compose.mcp.yml build

# Перезапуск всех сервисов
docker-compose -f ../../infra/docker-compose.mcp.yml up -d

# Проверка статуса всех сервисов
docker-compose -f ../../infra/docker-compose.mcp.yml ps
```

#### Отладка и диагностика

```bash
# Вход в контейнер для отладки
docker-compose -f ../../infra/docker-compose.mcp.yml exec binance-mcp bash

# Проверка переменных окружения в контейнере
docker-compose -f ../../infra/docker-compose.mcp.yml exec binance-mcp env

# Проверка доступности сервиса
curl http://localhost:8000/health
```

#### Очистка и пересборка с нуля

```bash
# Остановка и удаление контейнеров
docker-compose -f ../../infra/docker-compose.mcp.yml down

# Удаление образов (принудительная пересборка)
docker-compose -f ../../infra/docker-compose.mcp.yml build --no-cache binance-mcp

# Запуск с чистого листа
docker-compose -f ../../infra/docker-compose.mcp.yml up -d binance-mcp
```

## Мониторинг и логирование

### Логирование:
- **Уровни**: DEBUG, INFO, WARNING, ERROR
- **Формат**: Структурированные логи с контекстом
- **Ротация**: Автоматическая ротация логов

### Мониторинг:
- **Health check**: `/health` эндпоинт
- **Метрики**: Количество вызовов, ошибки
- **Алерты**: Telegram уведомления

## Безопасность

### Принципы:
1. **API ключи**: Никогда не коммитить в код
2. **Демо режим**: Изоляция тестовой торговли
3. **Валидация**: Проверка всех входных данных
4. **Rate limiting**: Соблюдение лимитов Binance API

### Рекомендации:
- Используйте демо режим для разработки
- Регулярно ротируйте API ключи
- Мониторьте использование API
- Настройте алерты на подозрительную активность

## Развитие проекта

### Приоритеты:
1. **Стабильность**: Надежная работа с Binance API
2. **Производительность**: Оптимизация запросов
3. **Функциональность**: Новые инструменты и возможности
4. **Безопасность**: Улучшение защиты

### Roadmap:
- [ ] Поддержка новых типов ордеров
- [ ] Расширенная аналитика портфеля
- [ ] Интеграция с другими биржами
- [ ] Веб-интерфейс для мониторинга

## Документация и отчёты

### ⚠️ ВАЖНО: Правила работы с документацией

**НЕ СОЗДАВАЙТЕ .md файлы отчёты каждый раз!**

- **НЕ создавайте** новые .md файлы для каждого изменения или отчёта
- **НЕ создавайте** файлы типа `REPORT_2024.md`, `CHANGES.md`, `UPDATE.md` и т.п.
- **НЕ дублируйте** информацию в разных файлах

### Ведение changelog:

**ВСЕГДА обновляйте существующие файлы:**

1. **`CHANGELOG.md`** - основной файл для записи изменений
2. **`README.md`** - обновляйте при значительных изменениях
3. **`AGENTS.md`** - обновляйте при изменениях архитектуры
4. **Существующие .md файлы** - дополняйте, не создавайте новые

### Формат changelog:
```markdown
## [Версия] - YYYY-MM-DD

### Добавлено
- Новая функциональность

### Изменено
- Изменения в существующей функциональности

### Исправлено
- Исправления ошибок

### Удалено
- Удаленная функциональность
```

### Принципы:
- **Консолидация**: Вся информация в существующих файлах
- **Обновление**: Редактируйте существующие файлы
- **Структурированность**: Используйте единый формат
- **Отслеживаемость**: Все изменения в changelog

## Качество кода и стандарты

### Code Review
- **Review guidelines**: Обязательный код-ревью для всех изменений
- **Performance benchmarks**: Бенчмарки производительности для критических путей

### Документация кода
- **API documentation**: Полная документация всех инструментов
- **Code comments**: Комментарии для сложной бизнес-логики
- **Type hints**: Обязательные аннотации типов для всех функций
- **Docstrings**: Строки документации для всех публичных методов

### Стандарты кодирования
- **PEP 8**: Строгое соблюдение стандартов Python
- **Black**: Автоматическое форматирование кода (длина строки 88)
- **Ruff**: Линтинг кода с правилами E, F, I
- **MyPy**: Строгая проверка типов (strict mode)

### Инструменты качества
```bash
# Форматирование кода
black .

# Линтинг
ruff check .

# Проверка типов
mypy .

# Тестирование
pytest tests/ --cov=src --cov-report=html

# Проверка безопасности
bandit -r src/
```

### Принципы разработки
- **SOLID принципы**: Следование принципам объектно-ориентированного дизайна
- **DRY**: Не повторяйся - избегание дублирования кода
- **KISS**: Простота и понятность кода
- **YAGNI**: Не добавляй функциональность "на всякий случай"

### Структура коммитов
- **Conventional Commits**: Использование стандартного формата
- **Prefixes**: `feat:`, `fix:`, `docs:`, `test:`, `refactor:`, `perf:`
- **Scope**: Указание области изменений
- **Breaking changes**: Явное указание критических изменений

### Примеры коммитов:
```bash
feat(api): добавить поддержку новых типов ордеров
fix(client): исправить обработку ошибок Binance API
docs(readme): обновить инструкции по установке
test(services): добавить тесты для PortfolioService
refactor(models): упростить структуру моделей данных
perf(cache): оптимизировать кэширование запросов
```
